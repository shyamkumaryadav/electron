# The config expects the following environment variables to be set:
#  - "GN_CONFIG" Build type. One of {'testing', 'release'}.
#  - "GN_EXTRA_ARGS" Additional gn arguments for a build config,
#      e.g. 'target_cpu="x86"' to build for a 32bit platform.
#      https://gn.googlesource.com/gn/+/master/docs/reference.md#target_cpu
#      Don't forget to set up "NPM_CONFIG_ARCH" and "TARGET_ARCH" accordingly
#      if you pass a custom value for 'target_cpu'.
#  - "ELECTRON_RELEASE" Set it to '1' upload binaries on success.
#  - "NPM_CONFIG_ARCH" E.g. 'x86'. Is used to build native Node.js modules.
#      Must match 'target_cpu' passed to "GN_EXTRA_ARGS" and "TARGET_ARCH" value.
#  - "TARGET_ARCH" Choose from {'ia32', 'x64', 'arm', 'arm64', 'mips64el'}.
#      Is used in some publishing scripts, but does NOT affect the Electron binary.
#      Must match 'target_cpu' passed to "GN_EXTRA_ARGS" and "NPM_CONFIG_ARCH" value.
#  - "UPLOAD_TO_STORAGE" Set it to '1' upload a release to the Azure bucket.
#      Otherwise the release will be uploaded to the GitHub Releases.
#      (The value is only checked if "ELECTRON_RELEASE" is defined.)
#
# The publishing scripts expect access tokens to be defined as env vars,
# but those are not covered here.
#
# AppVeyor docs on variables:
# https://www.appveyor.com/docs/environment-variables/
# https://www.appveyor.com/docs/build-configuration/#secure-variables
# https://www.appveyor.com/docs/build-configuration/#custom-environment-variables

version: 1.0.{build}
build_cloud: electron-16-core
image: vs2019bt-16.16.11
environment:
  GIT_CACHE_PATH: C:\Users\electron\libcc_cache
  ELECTRON_OUT_DIR: Default
  ELECTRON_ENABLE_STACK_DUMPING: 1
  ELECTRON_ALSO_LOG_TO_STDERR: 1
  MOCHA_REPORTER: mocha-multi-reporters
  MOCHA_MULTI_REPORTERS: mocha-appveyor-reporter, tap
  GOMA_FALLBACK_ON_AUTH_FAILURE: true

  matrix:

  - job_name: Build

  - job_name: Test
    job_depends_on: Build

for:

  -
    matrix:
      only:
        - job_name: Build

    build_script:
    - ps: |
        "This will be written to the text file" | Out-File -FilePath electron.log
        "This will be written to the text file" | Out-File -FilePath electron2.log
    - appveyor-retry appveyor PushArtifact electron.log
    - appveyor-retry appveyor PushArtifact electron2.log

  -
    matrix:
      only:
        - job_name: Test

    build_script:
    - dir *
    - ps: |
        $apiUrl = 'https://ci.appveyor.com/api'     
        # get build
        $build = Invoke-RestMethod -Method Get -Uri "$apiUrl/projects/$env:APPVEYOR_ACCOUNT_NAME/$env:APPVEYOR_PROJECT_SLUG/builds/$env:APPVEYOR_BUILD_ID"
        Write-Host "BUILD: $build"
        foreach ($job in $build.jobs) {
          Write-Host "JOB: $job"
          if ($job.name -eq "Build") {
            Write-Host "FOUND Build"
            $jobId = $job.jobId
            # get job artifacts (just to see what we've got)
            $artifacts = Invoke-RestMethod -Method Get -Uri "$apiUrl/buildjobs/$jobId/artifacts"
            Write-Host "Artifacts: $artifacts"
            foreach ($artifact in $artifacts) {              
              $artifactFileName = $artifact.fileName
              Write-Host "Downloading is: $artifactFileName"
              Invoke-RestMethod -Method Get -Uri "$apiUrl/buildjobs/$jobId/artifacts/$artifactFileName" -OutFile $artifactFileName
            }
          }
        }